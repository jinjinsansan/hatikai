(()=>{var e={};e.id=3,e.ids=[3],e.modules={7849:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external")},2934:e=>{"use strict";e.exports=require("next/dist/client/components/action-async-storage.external.js")},5403:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external")},4580:e=>{"use strict";e.exports=require("next/dist/client/components/request-async-storage.external.js")},4749:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external")},5869:e=>{"use strict";e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},3568:(e,t,a)=>{"use strict";a.r(t),a.d(t,{GlobalError:()=>r.a,__next_app__:()=>u,originalPathname:()=>m,pages:()=>d,routeModule:()=>h,tree:()=>o}),a(8142),a(3370),a(9765);var s=a(9082),i=a(8410),n=a(1152),r=a.n(n),l=a(9785),c={};for(let e in l)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(c[e]=()=>l[e]);a.d(t,c);let o=["",{children:["admin",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(a.bind(a,8142)),"/mnt/e/dev/hachikai/apps/web/app/admin/page.tsx"]}]},{}]},{layout:[()=>Promise.resolve().then(a.bind(a,3370)),"/mnt/e/dev/hachikai/apps/web/app/layout.tsx"],"not-found":[()=>Promise.resolve().then(a.t.bind(a,9765,23)),"next/dist/client/components/not-found-error"]}],d=["/mnt/e/dev/hachikai/apps/web/app/admin/page.tsx"],m="/admin/page",u={require:a,loadChunk:()=>Promise.resolve()},h=new s.AppPageRouteModule({definition:{kind:i.x.APP_PAGE,page:"/admin/page",pathname:"/admin",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:o}})},2394:(e,t,a)=>{Promise.resolve().then(a.bind(a,185))},3954:(e,t,a)=>{Promise.resolve().then(a.bind(a,5941))},4350:(e,t,a)=>{Promise.resolve().then(a.t.bind(a,7070,23)),Promise.resolve().then(a.t.bind(a,4426,23)),Promise.resolve().then(a.t.bind(a,3996,23)),Promise.resolve().then(a.t.bind(a,8235,23)),Promise.resolve().then(a.t.bind(a,1468,23)),Promise.resolve().then(a.t.bind(a,1864,23))},185:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>r});var s=a(3704),i=a(5542),n=a(2748);function r(){let[e,t]=(0,i.useState)(null),[a,r]=(0,i.useState)([]),[l,c]=(0,i.useState)([]),[o,d]=(0,i.useState)(""),[m,u]=(0,i.useState)(1),[h,x]=(0,i.useState)(0),[p,j]=(0,i.useState)("revolution"),[g,v]=(0,i.useState)(""),[b,N]=(0,i.useState)([]),[f,y]=(0,i.useState)(1),[w,S]=(0,i.useState)(""),[k,C]=(0,i.useState)("{}"),[P,O]=(0,i.useState)("{}"),[J,$]=(0,i.useState)(!0),[_,T]=(0,i.useState)("userId,tierId,lockDays\n"),[I,q]=(0,i.useState)("revolution"),[A,Z]=(0,i.useState)(""),[G,D]=(0,i.useState)(""),[E,K]=(0,i.useState)(""),[M,R]=(0,i.useState)([]),[L,U]=(0,i.useState)(""),[V,F]=(0,i.useState)(""),[X,z]=(0,i.useState)(""),[B,H]=(0,i.useState)(""),[Q,W]=(0,i.useState)(""),[Y,ee]=(0,i.useState)(""),[et,ea]=(0,i.useState)(""),[es,ei]=(0,i.useState)([]),en=async()=>{let e=await fetch("/api/admin/dashboard");t(e.ok?await e.json():null)},er=async()=>{let e=await fetch("/api/admin/tiers");if(!e.ok)return;let t=await e.json();if(N(t),t.length){let e=t[0];y(e.id),S(e.name),C(JSON.stringify(e.obligationsSchema,null,2)),O(JSON.stringify(e.perksSchema,null,2))}},el=async()=>{v("");let e=await fetch("/api/admin/force-tier",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({userId:o,tierId:Number(m),lockDays:Number(h)||void 0})}),t=await e.json();v(e.ok?"OK: 強制変更しました":`NG: ${t?.error||JSON.stringify(t)}`),en()},ec=async()=>{v("");let e=await fetch("/api/admin/events/trigger",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({kind:p})}),t=await e.json();v(e.ok?`OK: イベント発火 ${t.id}`:`NG: ${t?.error||JSON.stringify(t)}`),en()},eo=async()=>{await fetch("/api/admin/logout",{method:"POST"}),location.href="/admin/login"},ed=e=>{let t=b.find(t=>t.id===e);t&&(y(t.id),S(t.name),C(JSON.stringify(t.obligationsSchema,null,2)),O(JSON.stringify(t.perksSchema,null,2)))},em=async()=>{let e,t;v("");try{e=JSON.parse(k||"{}")}catch(e){v("Obligations JSONが不正です");return}try{t=JSON.parse(P||"{}")}catch(e){v("Perks JSONが不正です");return}let a=await fetch(`/api/admin/tiers/${f}`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({name:w,obligationsSchema:e,perksSchema:t,bumpVersion:J})}),s=await a.json();a.ok?(v("OK: ルールを保存しました"),er()):v(`NG: ${s?.error||JSON.stringify(s)}`)},eu=()=>{let e=_.split(/\r?\n/).filter(e=>e.trim().length),t=e.slice(e[0].includes(",")?1:0),a=[];for(let e of t){let[t,s,i]=e.split(",").map(e=>e.trim());if(!t)continue;let n=Number(s),r=i?Number(i):void 0;Number.isFinite(n)&&a.push({userId:t,tierId:n,lockDays:r})}return a},eh=async()=>{let e=eu();if(!e.length){v("CSVが空です");return}let t=await fetch("/api/admin/force-tier/bulk",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({items:e})}),a=await t.json();v(t.ok?`OK: ${a.count}件処理`:`NG: ${a?.error||JSON.stringify(a)}`),en()},ex=async()=>{let e=[{kind:I,windowFrom:A||void 0,windowTo:G||void 0}],t=await fetch("/api/admin/events/schedule",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({items:e})}),a=await t.json();v(t.ok?`OK: イベントを登録（${a.count}）`:`NG: ${a?.error||JSON.stringify(a)}`),en()},ep=async()=>{let e=new URLSearchParams;E&&e.set("q",E);let t=await fetch(`/api/admin/users?${e.toString()}`);R(t.ok?await t.json():[])},ej=e=>{d(e)},eg=async()=>{let e=new URLSearchParams;L&&e.set("userId",L);let t=await fetch(`/api/admin/transitions?${e.toString()}`);c(t.ok?await t.json():[])},ev=async()=>{let e=new URLSearchParams;V&&e.set("action",V),X&&e.set("role",X),B&&e.set("target",B),Q&&e.set("from",Q),Y&&e.set("to",Y);let t=await fetch(`/api/admin/audit?${e.toString()}`);r(t.ok?await t.json():[])};return(0,s.jsxs)("main",{children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[s.jsx("h1",{className:"text-2xl font-bold",children:"管理パネル（暫定）"}),s.jsx("button",{className:"btn",onClick:eo,children:"ログアウト"})]}),(0,s.jsxs)(n.Z,{title:"ダッシュボード",children:[s.jsx("pre",{className:"rounded bg-black/40 p-3 text-xs leading-relaxed",children:e?JSON.stringify(e,null,2):"loading..."}),(0,s.jsxs)("div",{className:"mt-4",children:[s.jsx("div",{className:"mb-2 text-sm text-white/70",children:"Tier分布推移（直近30日、JST）"}),(0,s.jsxs)("div",{className:"space-y-1",children:[es.map(e=>{let t=e.counts,a=Object.values(t).reduce((e,t)=>e+t,0)||1;return(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[s.jsx("div",{className:"w-24 shrink-0 text-xs text-white/60",children:new Date(e.day).toISOString().slice(0,10)}),s.jsx("div",{className:"h-3 flex w-full rounded bg-white/10 overflow-hidden",children:Array.from({length:8},(e,t)=>t+1).map(e=>{let i=t[String(e)]||0;return s.jsx("div",{className:`tier-${e}`,style:{width:`${i/a*100}%`}},e)})})]},e.day)}),s.jsx("div",{className:"mt-2 flex flex-wrap gap-2 text-xs text-white/70",children:Array.from({length:8},(e,t)=>t+1).map(e=>(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[s.jsx("span",{className:`inline-block h-3 w-3 rounded tier-${e}`}),e,"階"]},e))})]})]})]}),(0,s.jsxs)(n.Z,{title:"ユーザー検索 / 絞り込み",children:[(0,s.jsxs)("div",{className:"flex flex-col gap-2 md:flex-row md:items-center",children:[s.jsx("input",{className:"input",placeholder:"email/handle を含む",value:E,onChange:e=>K(e.target.value)}),s.jsx("button",{className:"btn",onClick:ep,children:"検索"})]}),s.jsx("div",{className:"mt-2 max-h-60 overflow-auto rounded border border-white/10 text-sm",children:M.map(e=>(0,s.jsxs)("div",{className:"flex items-center justify-between border-b border-white/10 px-2 py-1",children:[(0,s.jsxs)("div",{children:[s.jsx("div",{className:"font-mono",children:e.email||e.handle||e.id}),(0,s.jsxs)("div",{className:"text-xs text-white/50",children:[e.id," / tier: ",e.tierId??"-"]})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[s.jsx("button",{className:"btn",onClick:()=>ej(e.id),children:"強制変更にセット"}),s.jsx("button",{className:"btn",onClick:()=>U(e.id),children:"変動履歴フィルタにセット"})]})]},e.id))})]}),(0,s.jsxs)(n.Z,{title:"監査ログ（最近）",children:[(0,s.jsxs)("div",{className:"mb-2 grid grid-cols-1 gap-2 md:grid-cols-5",children:[s.jsx("input",{className:"input",placeholder:"action",value:V,onChange:e=>F(e.target.value)}),(0,s.jsxs)("select",{className:"input",value:X,onChange:e=>z(e.target.value),children:[s.jsx("option",{value:"",children:"role (all)"}),s.jsx("option",{value:"admin",children:"admin"}),s.jsx("option",{value:"user",children:"user"}),s.jsx("option",{value:"system",children:"system"})]}),s.jsx("input",{className:"input",placeholder:"target contains",value:B,onChange:e=>H(e.target.value)}),s.jsx("input",{className:"input",type:"datetime-local",value:Q,onChange:e=>W(e.target.value)}),s.jsx("input",{className:"input",type:"datetime-local",value:Y,onChange:e=>ee(e.target.value)})]}),s.jsx("div",{className:"mb-2",children:s.jsx("button",{className:"btn",onClick:ev,children:"絞り込む"})}),s.jsx("div",{className:"max-h-80 overflow-auto rounded border border-white/10 p-2 text-sm",children:a.map(e=>(0,s.jsxs)("div",{className:"border-b border-white/10 py-2",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsxs)("div",{children:[s.jsx("code",{children:e.createdAt})," [",e.actorRole,"] ",e.action," ",e.target?`target=${e.target}`:""]}),s.jsx("button",{className:"btn",onClick:()=>ea(et===e.id?"":e.id),children:et===e.id?"閉じる":"詳細"})]}),et===e.id&&s.jsx("pre",{className:"mt-2 rounded bg-black/40 p-2 text-xs",children:JSON.stringify(e.payload??{},null,2)})]},e.id))})]}),(0,s.jsxs)(n.Z,{title:"Tier変動（最近）",children:[(0,s.jsxs)("div",{className:"mb-2 flex items-center gap-2",children:[s.jsx("input",{className:"input",placeholder:"userIdで絞り込み",value:L,onChange:e=>U(e.target.value)}),s.jsx("button",{className:"btn",onClick:eg,children:"読込"})]}),s.jsx("div",{className:"max-h-60 overflow-auto rounded border border-white/10 p-2 text-sm",children:l.map(e=>(0,s.jsxs)("div",{className:"border-b border-white/10 py-1",children:[s.jsx("code",{children:e.decidedAt})," ",e.userEmail||e.userId,": ",e.from," → ",e.to," (",e.reason,")"]},e.id))})]}),s.jsx(n.Z,{title:"階層強制変更",children:(0,s.jsxs)("div",{className:"space-y-2",children:[s.jsx("input",{className:"input",placeholder:"userId",value:o,onChange:e=>d(e.target.value)}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[s.jsx("input",{className:"input w-24",type:"number",value:m,onChange:e=>u(Number(e.target.value)),min:1,max:8}),s.jsx("input",{className:"input w-32",type:"number",value:h,onChange:e=>x(Number(e.target.value)),min:0,placeholder:"lockDays"}),s.jsx("button",{className:"btn",onClick:el,children:"変更"})]})]})}),s.jsx(n.Z,{title:"イベント発火",children:(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsxs)("select",{className:"input w-48",value:p,onChange:e=>j(e.target.value),children:[s.jsx("option",{value:"revolution",children:"大革命"}),s.jsx("option",{value:"gekokujo",children:"下克上"}),s.jsx("option",{value:"custom",children:"custom"})]}),s.jsx("button",{className:"btn",onClick:ec,children:"発火"})]})}),s.jsx(n.Z,{title:"ルール編集（Tier）",children:(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsxs)("div",{children:[s.jsx("label",{className:"mr-2",children:"Tier:"}),s.jsx("select",{className:"input w-32 inline-block",value:f,onChange:e=>ed(Number(e.target.value)),children:b.map(e=>(0,s.jsxs)("option",{value:e.id,children:[e.id,": ",e.name]},e.id))})]}),s.jsx("input",{className:"input",placeholder:"name",value:w,onChange:e=>S(e.target.value)}),(0,s.jsxs)("div",{className:"grid gap-3 md:grid-cols-2",children:[(0,s.jsxs)("div",{children:[s.jsx("div",{className:"mb-1 text-sm",children:"obligationsSchema"}),s.jsx("textarea",{className:"textarea",value:k,onChange:e=>C(e.target.value),rows:12})]}),(0,s.jsxs)("div",{children:[s.jsx("div",{className:"mb-1 text-sm",children:"perksSchema"}),s.jsx("textarea",{className:"textarea",value:P,onChange:e=>O(e.target.value),rows:12})]})]}),(0,s.jsxs)("label",{className:"inline-flex items-center gap-2",children:[s.jsx("input",{type:"checkbox",checked:J,onChange:e=>$(e.target.checked)})," ルールバージョンを+1し、即時適用"]}),s.jsx("button",{className:"btn",onClick:em,children:"保存"})]})}),(0,s.jsxs)(n.Z,{title:"一括操作（CSV）",children:[(0,s.jsxs)("div",{className:"text-sm text-white/70",children:["フォーマット: ",s.jsx("code",{children:"userId,tierId,lockDays"})," （1行1ユーザー）"]}),s.jsx("textarea",{className:"textarea mt-2",value:_,onChange:e=>T(e.target.value),rows:8}),s.jsx("button",{className:"btn mt-2",onClick:eh,children:"一括Tier変更を実行"})]}),s.jsx(n.Z,{title:"イベントスケジュール",children:(0,s.jsxs)("div",{className:"flex flex-col gap-2 md:flex-row md:items-center",children:[(0,s.jsxs)("select",{className:"input w-48",value:I,onChange:e=>q(e.target.value),children:[s.jsx("option",{value:"revolution",children:"大革命"}),s.jsx("option",{value:"gekokujo",children:"下克上"}),s.jsx("option",{value:"custom",children:"custom"})]}),s.jsx("input",{className:"input",type:"datetime-local",value:A,onChange:e=>Z(e.target.value)}),s.jsx("input",{className:"input",type:"datetime-local",value:G,onChange:e=>D(e.target.value)}),s.jsx("button",{className:"btn",onClick:ex,children:"登録"})]})}),g&&s.jsx("p",{className:"mt-4 text-sm text-white/80",children:g})]})}},5941:(e,t,a)=>{"use strict";function s(){return null}a.d(t,{default:()=>s}),a(5542)},2748:(e,t,a)=>{"use strict";a.d(t,{Z:()=>i});var s=a(3704);function i({title:e,children:t}){return(0,s.jsxs)("section",{className:"mt-6 card",children:[s.jsx("h2",{className:"mb-3 text-lg font-semibold",children:e}),t]})}},8142:(e,t,a)=>{"use strict";a.r(t),a.d(t,{$$typeof:()=>r,__esModule:()=>n,default:()=>l});var s=a(6121);let i=(0,s.createProxy)(String.raw`/mnt/e/dev/hachikai/apps/web/app/admin/page.tsx`),{__esModule:n,$$typeof:r}=i;i.default;let l=(0,s.createProxy)(String.raw`/mnt/e/dev/hachikai/apps/web/app/admin/page.tsx#default`)},3370:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>d,metadata:()=>o});var s=a(9264);a(1923);var i=a(6121);let n=(0,i.createProxy)(String.raw`/mnt/e/dev/hachikai/apps/web/components/AppInit.tsx`),{__esModule:r,$$typeof:l}=n;n.default;let c=(0,i.createProxy)(String.raw`/mnt/e/dev/hachikai/apps/web/components/AppInit.tsx#default`),o={title:"ハチカイ",description:"階層\xd7ルーレット MVP"};function d({children:e}){return(0,s.jsxs)("html",{lang:"ja",children:[(0,s.jsxs)("head",{children:[s.jsx("link",{rel:"manifest",href:"/manifest.webmanifest"}),s.jsx("meta",{name:"theme-color",content:"#0b0b10"}),s.jsx("link",{rel:"icon",href:"/icons/icon-192.svg"}),s.jsx("link",{rel:"apple-touch-icon",href:"/icons/icon-192.svg"})]}),s.jsx("body",{className:"min-h-screen font-sans antialiased",children:(0,s.jsxs)("div",{className:"mx-auto max-w-5xl px-4 py-6",children:[s.jsx(c,{}),e]})})]})}},1923:()=>{}};var t=require("../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),s=t.X(0,[8915,7699],()=>a(3568));module.exports=s})();