# ハチカイ - 完全要件定義書 & 開発計画

## 1. コンセプト

**アプリ名**: ハチカイ
**コンセプト**: 階層制相互扶助システム（非対称型ギブアンドテイク）
- ユーザーが1-8階に振り分けられ、階層によって購入義務と特典が変動
- 上位階層が下位階層から一方的に恩恵を受ける仕組み
- 運とアルゴリズムで毎日階層が変動

## 2. 基本システム

### 2.1 ユーザー登録・初期配置
- 初回登録時：ルーレット演出で1-8階のいずれかに配置
- 欲しいものリスト登録（Amazon URL、1000-2000円の商品）
- アソシエイトURL混入チェック機能

### 2.2 階層システム詳細

#### **1階：「最下層」**
- **義務**: 誰かの商品1つ購入 + 広告3回/日視聴
- **特典**: 自分の商品1つ購入される
- **制約**: 義務未達成でルーレット参加不可

#### **2階：「借金階層」**
- **義務**: 誰かの商品2つ購入 + 広告2回/日視聴
- **特典**: 自分の商品1つ購入される
- **特殊ルール**: 購入された商品価値の50%が「借金」として蓄積、一定額超過で1階強制降格

#### **3階：「条件付き平等」**
- **義務**: 誰かの商品1つ購入 + 広告1回/日視聴
- **特典**: 自分の商品1つ購入される
- **特殊ルール**: 連続7日間条件未クリアで2階降格

#### **4階：「選択の自由」**
- **義務**: 週3つ購入 OR 広告視聴代わりに+1つ購入選択可
- **特典**: 週1つ購入される
- **特殊ルール**: 広告免除オプション有り

#### **5階：「優遇開始」**
- **義務**: 月2つ購入
- **特典**: 月3つ購入される
- **特殊ルール**: 他階層1人紹介で当月購入義務免除

#### **6階：「投資家気分」**
- **義務**: なし
- **特典**: 月1回自動購入 + 下位階層からの「配当」月1回
- **特殊ルール**: 下位階層購入時10%確率で追加利益

#### **7階：「ほぼ特権階級」**
- **義務**: なし
- **特典**: 週1回自動購入
- **特殊ルール**: 1-3階の広告視聴でポイント蓄積→月1回商品交換

#### **8階：「最上階」**
- **義務**: なし
- **特典**: 常時購入される（継続的）
- **制約**: 60日以上滞在で強制的に1-3階ランダム配置

## 3. ルーレットアルゴリズム

### 3.1 基本確率
- 1階: 30% / 2階: 20% / 3階: 15% / 4階: 12% / 5階: 10% / 6階: 8% / 7階: 3% / 8階: 2%

### 3.2 確率修正要素

#### **ボーナス要素（上昇確率UP）**
- 紹介人数: 1人につき+2%
- 広告超過視聴: 必要回数の2倍で+3%
- 連続ログイン: 7日+1%、30日+5%
- 借金完済（2階）: +10%

#### **ペナルティ要素（下降確率UP）**
- 義務未達成: +15%下位確率
- 長期滞在: 30日以上同階層で+3%/週
- 8階長期滞在: 60日以上で強制降格

### 3.3 特殊イベント
- **大革命の日**: 月1回、全階層完全ランダムリセット
- **下克上の日**: 週1回、1-3階の上昇確率大幅UP

## 4. 技術要件

### 4.1 必要なAPI・サービス
- Amazon Product Advertising API
- Google AdSense API
- Supabase (認証・データベース)
- Firebase Cloud Messaging (プッシュ通知)
- Vercel (ホスティング)

### 4.2 データベース設計
- users (ユーザー情報)
- tiers (階層情報)
- tier_history (階層履歴)
- wish_items (欲しいものリスト)
- purchase_obligations (購入義務)
- purchase_history (購入履歴)
- ad_obligations (広告視聴義務)
- ad_history (広告視聴履歴)
- roulette_history (ルーレット履歴)

---

# 開発計画

## 現在の実装状況

### ✅ 実装済み
- Google OAuth認証
- 基本的なルーレット演出
- 欲しいものリスト（基本機能）
- 管理画面（基本）
- Supabase連携
- Vercelデプロイ

### ❌ 未実装（重要度順）
1. **階層システム全体**
2. **Amazon PA-API連携**
3. **購入義務・確認システム**
4. **広告システム**
5. **自動スケジューラー（毎日0時）**
6. **管理者パネル拡張**

---

## 開発フェーズ

### **Phase 1: データベース・階層システム基盤** (1-2週間)

#### 1.1 データベース設計
- [ ] Prismaスキーマ更新
  - tiers テーブル追加
  - tier_history テーブル追加
  - purchase_obligations テーブル追加
  - ad_obligations テーブル追加
- [ ] マイグレーション実行
- [ ] シードデータ作成

#### 1.2 階層システム実装
- [ ] 階層モデル作成（1-8階）
- [ ] 階層別の義務・特典ロジック
- [ ] ユーザー初期配置ロジック
- [ ] 階層表示UI

#### 1.3 ルーレットアルゴリズム
- [ ] 基本確率実装
- [ ] ボーナス/ペナルティ計算
- [ ] ルーレット結果の階層反映

#### テスト項目
- [ ] ユーザー登録時の階層配置
- [ ] 階層別の義務表示
- [ ] ルーレット確率計算

---

### **Phase 2: スケジューラー・自動処理** (1週間)

#### 2.1 毎日0時の処理
- [ ] Cronジョブ設定
- [ ] 階層変更ロジック
- [ ] 義務リセット
- [ ] 通知送信

#### 2.2 特殊イベント
- [ ] 大革命の日（月1回）
- [ ] 下克上の日（週1回）

#### テスト項目
- [ ] 自動階層変更
- [ ] 義務期限チェック
- [ ] イベント発動

---

### **Phase 3: Amazon PA-API連携** (2-3週間)

#### 3.1 API設定
- [ ] PA-API認証情報取得
- [ ] API連携実装
- [ ] ASIN抽出機能

#### 3.2 商品管理
- [ ] 欲しいものリスト拡張
- [ ] アソシエイトURL生成
- [ ] 価格範囲チェック（1000-2000円）

#### 3.3 購入追跡
- [ ] 購入リンク生成
- [ ] 購入確認システム（第1段階）
- [ ] 手動確認フォーム（第2段階）

#### テスト項目
- [ ] Amazon URL→ASIN変換
- [ ] アソシエイトリンク生成
- [ ] 購入フロー

---

### **Phase 4: 広告システム** (1週間)

#### 4.1 広告表示
- [ ] Google AdSense統合
- [ ] 階層別の広告回数管理
- [ ] 広告視聴画面UI

#### 4.2 視聴確認
- [ ] 視聴完了判定
- [ ] 視聴履歴記録
- [ ] 義務達成チェック

#### テスト項目
- [ ] 広告表示
- [ ] 視聴カウント
- [ ] 義務達成判定

---

### **Phase 5: 管理者パネル拡張** (1週間)

#### 5.1 ダッシュボード
- [ ] リアルタイム統計
- [ ] 階層分布グラフ
- [ ] 収益レポート

#### 5.2 ユーザー管理
- [ ] 階層強制変更
- [ ] 購入確認・承認
- [ ] ペナルティ設定

#### 5.3 広告管理
- [ ] 広告差し込み
- [ ] スケジュール配信
- [ ] 収益分析

#### テスト項目
- [ ] 管理機能の動作確認
- [ ] データの正確性
- [ ] 権限管理

---

### **Phase 6: 不正対策・最適化** (2週間)

#### 6.1 不正検出
- [ ] 複数アカウント検出
- [ ] 異常購入パターン
- [ ] アソシエイトURL混入チェック

#### 6.2 パフォーマンス
- [ ] キャッシュ最適化
- [ ] API呼び出し最適化
- [ ] データベースインデックス

#### 6.3 セキュリティ
- [ ] 入力検証強化
- [ ] Rate Limiting
- [ ] ログ監視

---

## テスト戦略

### 各フェーズのテスト方法

1. **単体テスト**: 各機能の個別動作確認
2. **統合テスト**: システム間の連携確認
3. **E2Eテスト**: ユーザーフロー全体の確認
4. **負荷テスト**: 同時アクセス・大量データ

### テスト環境
- **開発環境**: localhost
- **ステージング**: Vercel Preview
- **本番環境**: hatikai-web.vercel.app

---

## 現在のタスク優先順位

1. **緊急**: Phase 1のデータベース設計
2. **重要**: 階層システムの実装
3. **通常**: UI/UXの改善
4. **保留**: ネイティブアプリ開発

---

## コマンド・スクリプト

### 開発用コマンド
```bash
# 開発サーバー起動
pnpm dev

# ビルド
pnpm build

# テスト
pnpm test

# データベースマイグレーション
pnpm prisma migrate dev

# データベースシード
pnpm prisma db seed

# 型チェック
pnpm typecheck

# リント
pnpm lint
```

### 環境変数
```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=

# API
API_URL=http://localhost:3001

# Amazon PA-API (Phase 3で追加)
AMAZON_ACCESS_KEY=
AMAZON_SECRET_KEY=
AMAZON_PARTNER_TAG=

# Google AdSense (Phase 4で追加)
GOOGLE_ADSENSE_CLIENT=

# Admin
ADMIN_TOKEN=
```

---

## 進捗管理

### 完了したフェーズ
- [x] 初期セットアップ
- [x] 認証システム
- [x] 基本UI

### 現在作業中
- [ ] Phase 1: データベース・階層システム基盤

### 次の作業
- [ ] Phase 2: スケジューラー・自動処理

---

## 注意事項

1. **Amazon PA-API**: 申請が必要、審査に時間がかかる
2. **Google AdSense**: サイトの審査が必要
3. **階層バランス**: 初期は調整が必要
4. **法的確認**: ギャンブル性の確認が必要

---

最終更新: 2025-09-20